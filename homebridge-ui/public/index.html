<form id="configForm" autocomplete="off">
  <div class="card card-body mb-4">
      <label style="font-size:1.5rem">MQTT</label>
      <div class="form-group">
          <label class="control-label" for="mqttBroker">Broker <strong class="text-danger">*</strong></label>
          <input class="form-control" id="mqttBroker" name="host" type="text" required="true">
      </div>
      <div class="form-group">
          <label class="control-label" for="mqttPort">Port <strong class="text-danger">*</strong></label>
          <input class="form-control" id="mqttPort" name="port" type="text" required="true">
      </div>
      <div class="form-group">
          <label class="control-label" for="mqttUsername">Username</label>
          <input class="form-control" id="mqttUsername" name="user" type="text" required="false">
      </div>
      <div class="form-group">
          <label class="control-label" for="mqttPassword">Password</label>
          <input class="form-control" id="mqttPassword" name="password" type="text" required="false">
      </div>
  </div>
  <div class="card card-body mb-4">
      <label style="font-size:1.5rem">RF Bridge</label>
      <div class="form-group">
          <label class="control-label" for="rfbridgeTopic">Topic <strong class="text-danger">*</strong></label>
          <input class="form-control" id="rfbridgeTopic" name="topic" type="text" required="true">
      </div>
      <div class="form-group">
          <label class="control-label" for="rfbridgeProtocol">Protocol Index <strong class="text-danger">*</strong></label>
          <input class="form-control" id="rfbridgeProtocol" name="protocol" type="text" required="true">
      </div>
  </div>
  <div class="card card-body mb-4">
    <div class="list-group">
      <fieldset>
        <legend>Remotes</legend>
        <div id="remotes">
        </div>
        <div class="form-group">
          <button id="addRemote" class="btn btn-default fa-pull-right">Add Remote</button>
        </div>
      </fieldset>
    </div>
  </div>
</form>
<script>
(async () => {
  // get the initial config - this is an array potentially containing multiple config blocks
  homebridge.showSpinner();
  const pluginConfig = await homebridge.getPluginConfig();
  const pluginConfigSchema = await homebridge.getPluginConfigSchema();
  homebridge.hideSpinner();

  console.log(JSON.stringify(pluginConfig, null, 2));

  function newRemote(key, name="", id="") {
    const remotesContainer = document.querySelector("#remotes");
    const container = document.createElement("div");
    container.innerHTML = `
            <div class="list-group-item mb-3">
              <button type="button" id="removeRemote${key}" class="close pull-right">
                <span aria-hidden="true">Ã—</span><span class="sr-only">Remove</span>
              </button>
              <div class="form-group">
                  <label class="control-label" for="remoteName${key}">Name <strong class="text-danger">*</strong></label>
                  <input class="form-control" id="remoteName${key}" name="name" type="text" required="true" value="${name}">
              </div>
              <div class="form-group">
                  <label class="control-label" for="remoteID${key}">Remote ID <strong class="text-danger">*</strong></label>
                  <input class="form-control" id="remoteID${key}" name="remote_id" type="text" required="true" value="${id}">
                  <p class="help-block">
                    Nibble 1-40 of remote payload. Use either HEX or Binary representation.<br/>
                    Example: 0010101110101001001111001110001110111101
                  </p>
              </div>
            </div>\n`;
    remotesContainer.appendChild(container);


    container.querySelector(`#removeRemote${key}`).addEventListener('click', ()=>{
      remotesContainer.removeChild(container);
      const remoteIndex = pluginConfig[0].remotes.findIndex(v=>v.id===key);
      pluginConfig[0].remotes.splice(remoteIndex,1);
      homebridge.updatePluginConfig(pluginConfig);
    });
  }


  // get the intial from the config and add it to the form
  if (!pluginConfig.length){
    pluginConfig.push({
      mqtt: {
        host: schema.schema.properties.mqtt.properties.host.default,
        port: schema.schema.properties.mqtt.properties.port.default,
        user: "",
        password: ""
      },
      rfbridge: {
        topic: "",
        protocol: schema.schema.properties.rfbridge.properties.protocol.default
      },
      remotes: []
    });
  }

  //mqttBroker mqttPort mqttUsername mqttPassword
  document.querySelector('#mqttBroker').value = pluginConfig[0].mqtt.host;
  document.querySelector('#mqttPort').value = pluginConfig[0].mqtt.port;
  document.querySelector('#mqttUsername').value = pluginConfig[0].mqtt.user;
  document.querySelector('#mqttPassword').value = pluginConfig[0].mqtt.password;

  //rfbridgeTopic rfbridgeProtocol
  document.querySelector('#rfbridgeTopic').value = pluginConfig[0].rfbridge.topic;
  document.querySelector('#rfbridgeProtocol').value = pluginConfig[0].rfbridge.protocol;

  //remote0Name remote0ID
  pluginConfig[0].remotes.forEach((remote, remoteIndex)=>{
    const id = remote._id ? remote._id : (()=>{
      const _id = Date.now();
      pluginConfig[0].remotes[remoteIndex]._id = _id;
      homebridge.updatePluginConfig(pluginConfig);
      return _id;
    })();
    
    newRemote(id, remote.name, remote.remote_id);
  })

  // watch for changes to the form and update the config
  document.getElementById('configForm').addEventListener('input', () => {
      // get the current values from the form
      
      //mqttBroker mqttPort mqttUsername mqttPassword
      pluginConfig[0].mqtt.host = document.querySelector('#mqttBroker').value;
      pluginConfig[0].mqtt.port = document.querySelector('#mqttPort').value;
      pluginConfig[0].mqtt.user = document.querySelector('#mqttUsername').value;
      pluginConfig[0].mqtt.password = document.querySelector('#mqttPassword').value;

      //rfbridgeTopic rfbridgeProtocol
      pluginConfig[0].rfbridge.topic = document.querySelector('#rfbridgeTopic').value;
      pluginConfig[0].rfbridge.protocol = document.querySelector('#rfbridgeProtocol').value;

      for(let remoteIndex = 0; remoteIndex < pluginConfig[0].remotes.length; remoteIndex++) {
        pluginConfig[0].remotes[remoteIndex].name = document.querySelector(`#remoteName${remoteIndex}`).value;
        pluginConfig[0].remotes[remoteIndex].remote_id = document.querySelector(`#remoteID${remoteIndex}`).value;
      }

      // update the config
      homebridge.updatePluginConfig(pluginConfig);
  });

  document.querySelector('#addRemote').addEventListener('click', ()=>{
    newRemote(pluginConfig[0].remotes.length);
    pluginConfig[0].remotes.push({name:"", remote_id:"", id:Date.now()});
    homebridge.updatePluginConfig(pluginConfig);
  });

  /*
  // watch for click events on the getTokenButton
  document.querySelector('#getTokenButton').addEventListener('click', async () => {
      // validate a username was provided
      const username = document.querySelector('#userNameInput').value;

      if (!username) {
          // create a error / red toast notification if the required input is not provided.
          homebridge.toast.error('A username must be provided.', 'Error');
          return;
      }

      // starting the request, show the loading spinner
      homebridge.showSpinner();

      // request a token from the server
      try {
          const response = await homebridge.request('/token', {
              username: username,
          });

          // update the token input with the response
          document.querySelector('#tokenInput').value = response.token;

          // update the plugin config
          pluginConfig[0].token = response.token;
          homebridge.updatePluginConfig(pluginConfig);

          // show a success toast notification
          homebridge.toast.success('Got Token!', 'Success');
      } catch (e) {
          homebridge.toast.error(e.error, e.message);
      } finally {
          // remember to un-hide the spinner
          homebridge.hideSpinner();
      }
  });
  */
})();
</script>